#!/usr/bin/env ruby

$: << File.join( File.dirname(__FILE__), '..', 'lib' )

require 'rubygems'
require 'bundler'

Gem.platforms.push( Gem::Platform::JAVA )

require 'rumpler/config'
require 'rumpler/gemfile_converter'
require 'rumpler/gemspec_converter'

require 'rumpler/application_converter'

require 'ostruct'

batch = OpenStruct.new

batch.output_dir         = './build'
batch.inhibit_exclusions = false

opts = OptionParser.new do |opts|

  opts.banner = "Usage: rumpler [options]"

  opts.separator ""
  opts.separator "Specific options:"

  opts.on( '-a', '--application' ) do
    batch.mode = :application
  end

  opts.on( '-G', '--gemfile' ) do 
    batch.mode    = :gemfile
  end

  opts.on( '-g', '--gem' ) do 
    batch.mode    = :gem
  end

  opts.on( '-o', '--output OUTPDIR' ) do |output_dir|
    batch.output_dir = output_dir
  end

  opts.on('-i', '--inhibit-exclusions', 'Inhibit default exclusions' ) do
    batch.inhibit_exclusions = true
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end


end

opts.parse!( ARGV )

case ( batch.mode )
  when :application
    if ( ARGV.empty? )
      converter = Rumpler::ApplicationConverter.new( Dir.pwd, batch.output_dir ).dump
    else
      puts "Argument not accepted yet, complain to Bob"
    end
  when :gemfile
    ARGV.each do |gemfile|
      converter = Rumpler::GemfileConverter.new( gemfile, batch.output_dir )
      converter.inhibit_exclusions = batch.inhibit_exclusions
      converter.dump
    end
end
